{{page-title "Registration & Management"}}

<div class="section-header">
  <h5><i class="bi bi-person-plus-fill"></i> Registration &amp; Management</h5>
</div>

{{!-- Toast --}}
{{#if this.statusMessage}}
  <div class="toast-notification {{this.statusType}}" role="alert">
    <i class="bi {{if (eq this.statusType 'success') 'bi-check-circle-fill' 'bi-exclamation-triangle-fill'}}"></i>
    {{this.statusMessage}}
  </div>
{{/if}}

{{!-- Tab Navigation --}}
<div class="tab-nav mb-4">
  <button class="tab-btn {{if (eq this.activeTab 'player') 'active'}}" type="button" {{on "click" (fn this.setTab "player")}}>
    <i class="bi bi-person-arms-up"></i> Players
  </button>
  <button class="tab-btn {{if (eq this.activeTab 'bull') 'active'}}" type="button" {{on "click" (fn this.setTab "bull")}}>
    <i class="bi bi-shield-fill"></i> Bulls
  </button>
  <button class="tab-btn {{if (eq this.activeTab 'owner') 'active'}}" type="button" {{on "click" (fn this.setTab "owner")}}>
    <i class="bi bi-person-badge-fill"></i> Owners
  </button>
  <button class="tab-btn {{if (eq this.activeTab 'organizer') 'active'}}" type="button" {{on "click" (fn this.setTab "organizer")}}>
    <i class="bi bi-building"></i> Organizers
  </button>
  <button class="tab-btn {{if (eq this.activeTab 'match') 'active'}}" type="button" {{on "click" (fn this.setTab "match")}}>
    <i class="bi bi-calendar-plus"></i> Schedule Match
  </button>
</div>

{{!-- ═══════════════════════════════════════ --}}
{{!-- ═══════ PLAYERS TAB ═══════ --}}
{{!-- ═══════════════════════════════════════ --}}
{{#if (eq this.activeTab "player")}}

  {{!-- Create New Player --}}
  <div class="card mb-4 border-primary">
    <div class="card-body">
      <h6 class="fw-bold mb-3"><i class="bi bi-person-plus text-primary"></i> Create New Player</h6>
      <form {{on "submit" this.createPlayer}}>
        <div class="row g-3">
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Name <span class="text-danger">*</span></label>
            <input type="text" name="player_name" class="form-control form-control-sm" required placeholder="Full name">
          </div>
          <div class="col-md-2 col-6">
            <label class="form-label small fw-semibold">Date of Birth</label>
            <input type="date" name="dob" class="form-control form-control-sm">
          </div>
          <div class="col-md-2 col-6">
            <label class="form-label small fw-semibold">Aadhaar <span class="text-danger">*</span></label>
            <input type="text" name="aadhaar" class="form-control form-control-sm" required placeholder="12 digits" maxlength="12" pattern="\d{12}">
          </div>
          <div class="col-md-2 col-6">
            <label class="form-label small fw-semibold">Phone <span class="text-danger">*</span></label>
            <input type="text" name="phone" class="form-control form-control-sm" required placeholder="10 digits" maxlength="10" pattern="\d{10}">
          </div>
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Link to User (optional)</label>
            <select name="user_id" class="form-select form-select-sm">
              <option value="">None</option>
              {{#each @model.users as |u|}}
                {{#if (eq u.role "player")}}
                  <option value={{u.user_id}}>{{u.username}} ({{u.full_name}})</option>
                {{/if}}
              {{/each}}
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-primary btn-sm mt-3"><i class="bi bi-plus-lg"></i> Create Player</button>
      </form>
    </div>
  </div>

  {{!-- Register Player for Match --}}
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="fw-bold mb-3"><i class="bi bi-person-check text-success"></i> Register Player for Match</h6>
      <form {{on "submit" this.registerPlayer}}>
        <div class="row g-3">
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Match <span class="text-danger">*</span></label>
            <select name="match_id" class="form-select form-select-sm" required>
              <option value="">Select match...</option>
              {{#each @model.scheduledMatches as |m|}}
                <option value={{m.match_id}}>{{m.match_name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Player <span class="text-danger">*</span></label>
            <select name="player_id" class="form-select form-select-sm" required>
              <option value="">Select player...</option>
              {{#each @model.players as |p|}}
                <option value={{p.player_id}}>{{p.player_name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Round <span class="text-danger">*</span></label>
            <select name="round_type_id" class="form-select form-select-sm" required>
              <option value="">Select round...</option>
              {{#each @model.roundTypes as |r|}}
                <option value={{r.round_type_id}}>{{r.round_name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Batch <span class="text-danger">*</span></label>
            <select name="batch_id" class="form-select form-select-sm" required>
              <option value="">Select batch...</option>
              {{#each @model.batches as |b|}}
                <option value={{b.batch_id}}>{{b.batch_name}}</option>
              {{/each}}
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-success btn-sm mt-3"><i class="bi bi-check-lg"></i> Register</button>
      </form>
    </div>
  </div>

  {{!-- Pending Player Registrations --}}
  <div class="card">
    <div class="card-body p-0 table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th>Match</th><th>Player</th><th>Round</th><th>Status</th><th class="text-end">Action</th></tr>
        </thead>
        <tbody>
          {{#each @model.pendingPlayers as |p|}}
            <tr>
              <td>{{p.match_name}}</td>
              <td class="fw-semibold">{{p.player_name}}</td>
              <td><span class="badge bg-secondary">{{p.round_name}}</span></td>
              <td>
                <span class="status-badge {{if (eq p.status 'approved') 'approved' 'pending'}}">{{p.status}}</span>
              </td>
              <td class="text-end">
                {{#if (eq p.status "registered")}}
                  <button class="btn btn-success btn-sm" type="button"
                    {{on "click" (fn this.approvePlayer p.match_id p.player_id p.round_type_id)}}>
                    <i class="bi bi-check-lg"></i> Approve
                  </button>
                {{else}}
                  <i class="bi bi-check-circle-fill text-success"></i>
                {{/if}}
              </td>
            </tr>
          {{else}}
            <tr>
              <td colspan="5">
                <div class="empty-state py-3"><i class="bi bi-inbox"></i><p>No player registrations</p></div>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>

  {{!-- All Players List --}}
  <div class="card mt-4">
    <div class="card-body p-0 table-responsive">
      <h6 class="fw-bold p-3 mb-0"><i class="bi bi-list-ul"></i> All Players ({{@model.players.length}})</h6>
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th>ID</th><th>Name</th><th>DOB</th><th>Aadhaar</th><th>Phone</th></tr>
        </thead>
        <tbody>
          {{#each @model.players as |p|}}
            <tr>
              <td class="text-muted small">{{p.player_id}}</td>
              <td class="fw-semibold">{{p.player_name}}</td>
              <td>{{p.DOB}}</td>
              <td class="small">{{p.Aadhaar}}</td>
              <td class="small">{{p.Phone_number}}</td>
            </tr>
          {{else}}
            <tr><td colspan="5"><div class="empty-state py-3"><p>No players yet</p></div></td></tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
{{/if}}

{{!-- ═══════════════════════════════════════ --}}
{{!-- ═══════ BULLS TAB ═══════ --}}
{{!-- ═══════════════════════════════════════ --}}
{{#if (eq this.activeTab "bull")}}

  {{!-- Create New Bull --}}
  <div class="card mb-4 border-danger">
    <div class="card-body">
      <h6 class="fw-bold mb-3"><i class="bi bi-shield-fill-plus text-danger"></i> Create New Bull</h6>
      <form {{on "submit" this.createBull}}>
        <div class="row g-3">
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Bull Name <span class="text-danger">*</span></label>
            <input type="text" name="bull_name" class="form-control form-control-sm" required placeholder="e.g. Kodai">
          </div>
          <div class="col-md-2 col-6">
            <label class="form-label small fw-semibold">Age (yrs) <span class="text-danger">*</span></label>
            <input type="number" name="age" class="form-control form-control-sm" required min="1" max="30">
          </div>
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Owner <span class="text-danger">*</span></label>
            <select name="owner_id" class="form-select form-select-sm" required>
              <option value="">Select owner...</option>
              {{#each @model.owners as |o|}}
                <option value={{o.owner_id}}>{{o.name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-2 col-6">
            <label class="form-label small fw-semibold">Breed <span class="text-danger">*</span></label>
            <select name="breed_id" class="form-select form-select-sm" required>
              <option value="">Select breed...</option>
              {{#each @model.breeds as |b|}}
                <option value={{b.bull_breed_id}}>{{b.bull_breed_name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-2 col-6">
            <label class="form-label small fw-semibold">Fitness Cert</label>
            <input type="text" name="fitness_cert" class="form-control form-control-sm" placeholder="Certificate #">
          </div>
        </div>
        <button type="submit" class="btn btn-danger btn-sm mt-3"><i class="bi bi-plus-lg"></i> Create Bull</button>
      </form>
    </div>
  </div>

  {{!-- Register Bull for Match --}}
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="fw-bold mb-3"><i class="bi bi-shield-fill-check text-success"></i> Register Bull for Match</h6>
      <form {{on "submit" this.registerBull}}>
        <div class="row g-3">
          <div class="col-md-4">
            <label class="form-label small fw-semibold">Match <span class="text-danger">*</span></label>
            <select name="match_id" class="form-select form-select-sm" required>
              <option value="">Select match...</option>
              {{#each @model.scheduledMatches as |m|}}
                <option value={{m.match_id}}>{{m.match_name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small fw-semibold">Bull <span class="text-danger">*</span></label>
            <select name="bull_id" class="form-select form-select-sm" required>
              <option value="">Select bull...</option>
              {{#each @model.bulls as |b|}}
                <option value={{b.bull_id}}>{{b.bull_name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-4">
            <label class="form-label small fw-semibold">Round <span class="text-danger">*</span></label>
            <select name="round_type_id" class="form-select form-select-sm" required>
              <option value="">Select round...</option>
              {{#each @model.roundTypes as |r|}}
                <option value={{r.round_type_id}}>{{r.round_name}}</option>
              {{/each}}
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-success btn-sm mt-3"><i class="bi bi-check-lg"></i> Register</button>
      </form>
    </div>
  </div>

  {{!-- Pending Bull Registrations --}}
  <div class="card">
    <div class="card-body p-0 table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th>Match</th><th>Bull</th><th>Round</th><th>Status</th><th class="text-end">Action</th></tr>
        </thead>
        <tbody>
          {{#each @model.pendingBulls as |b|}}
            <tr>
              <td>{{b.match_name}}</td>
              <td class="fw-semibold">{{b.bull_name}}</td>
              <td><span class="badge bg-secondary">{{b.round_name}}</span></td>
              <td>
                <span class="status-badge {{if (eq b.status 'approved') 'approved' 'pending'}}">{{b.status}}</span>
              </td>
              <td class="text-end">
                {{#if (eq b.status "registered")}}
                  <button class="btn btn-success btn-sm" type="button"
                    {{on "click" (fn this.approveBull b.match_id b.bull_id b.round_type_id)}}>
                    <i class="bi bi-check-lg"></i> Approve
                  </button>
                {{else}}
                  <i class="bi bi-check-circle-fill text-success"></i>
                {{/if}}
              </td>
            </tr>
          {{else}}
            <tr>
              <td colspan="5">
                <div class="empty-state py-3"><i class="bi bi-inbox"></i><p>No bull registrations</p></div>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>

  {{!-- All Bulls List --}}
  <div class="card mt-4">
    <div class="card-body p-0 table-responsive">
      <h6 class="fw-bold p-3 mb-0"><i class="bi bi-list-ul"></i> All Bulls ({{@model.bulls.length}})</h6>
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th>ID</th><th>Name</th><th>Age</th><th>Owner</th><th>Breed</th><th>Fitness</th></tr>
        </thead>
        <tbody>
          {{#each @model.bulls as |b|}}
            <tr>
              <td class="text-muted small">{{b.bull_id}}</td>
              <td class="fw-semibold">{{b.bull_name}}</td>
              <td>{{b.age}}</td>
              <td>{{b.owner_id}}</td>
              <td>{{b.bull_breed_id}}</td>
              <td class="small">{{b.fitness_certificate}}</td>
            </tr>
          {{else}}
            <tr><td colspan="6"><div class="empty-state py-3"><p>No bulls yet</p></div></td></tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
{{/if}}

{{!-- ═══════════════════════════════════════ --}}
{{!-- ═══════ OWNERS TAB ═══════ --}}
{{!-- ═══════════════════════════════════════ --}}
{{#if (eq this.activeTab "owner")}}

  {{!-- Create New Owner --}}
  <div class="card mb-4 border-warning">
    <div class="card-body">
      <h6 class="fw-bold mb-3"><i class="bi bi-person-badge text-warning"></i> Create New Owner</h6>
      <form {{on "submit" this.createOwner}}>
        <div class="row g-3">
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Owner Name <span class="text-danger">*</span></label>
            <input type="text" name="name" class="form-control form-control-sm" required placeholder="Full name">
          </div>
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Aadhaar <span class="text-danger">*</span></label>
            <input type="text" name="aadhaar" class="form-control form-control-sm" required placeholder="12 digits" maxlength="12" pattern="\d{12}">
          </div>
          <div class="col-md-3 col-6">
            <label class="form-label small fw-semibold">Link to User (optional)</label>
            <select name="user_id" class="form-select form-select-sm">
              <option value="">None</option>
              {{#each @model.users as |u|}}
                {{#if (eq u.role "owner")}}
                  <option value={{u.user_id}}>{{u.username}} ({{u.full_name}})</option>
                {{/if}}
              {{/each}}
            </select>
          </div>
        </div>
        <button type="submit" class="btn btn-warning btn-sm mt-3"><i class="bi bi-plus-lg"></i> Create Owner</button>
      </form>
    </div>
  </div>

  {{!-- Owners List --}}
  <div class="card">
    <div class="card-body p-0 table-responsive">
      <h6 class="fw-bold p-3 mb-0"><i class="bi bi-list-ul"></i> All Owners ({{@model.owners.length}})</h6>
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th>ID</th><th>Name</th><th>Aadhaar</th><th>Bulls Owned</th></tr>
        </thead>
        <tbody>
          {{#each @model.owners as |o|}}
            <tr>
              <td class="text-muted small">{{o.owner_id}}</td>
              <td class="fw-semibold">{{o.name}}</td>
              <td class="small">{{o.Aadhaar}}</td>
              <td>
                {{#each @model.bulls as |b|}}
                  {{#if (eq b.owner_id o.owner_id)}}
                    <span class="badge bg-secondary me-1">{{b.bull_name}}</span>
                  {{/if}}
                {{/each}}
              </td>
            </tr>
          {{else}}
            <tr><td colspan="4"><div class="empty-state py-3"><p>No owners yet</p></div></td></tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
{{/if}}

{{!-- ═══════════════════════════════════════ --}}
{{!-- ═══════ ORGANIZERS TAB ═══════ --}}
{{!-- ═══════════════════════════════════════ --}}
{{#if (eq this.activeTab "organizer")}}

  {{!-- Create New Organizer --}}
  <div class="card mb-4 border-info">
    <div class="card-body">
      <h6 class="fw-bold mb-3"><i class="bi bi-building text-info"></i> Create New Organizer</h6>
      <form {{on "submit" this.createOrganizer}}>
        <div class="row g-3">
          <div class="col-md-4 col-6">
            <label class="form-label small fw-semibold">Organizer Name <span class="text-danger">*</span></label>
            <input type="text" name="organizer_name" class="form-control form-control-sm" required placeholder="e.g. Alanganallur Panchayat">
          </div>
        </div>
        <button type="submit" class="btn btn-info btn-sm mt-3"><i class="bi bi-plus-lg"></i> Create Organizer</button>
      </form>
    </div>
  </div>

  {{!-- Organizers List --}}
  <div class="card">
    <div class="card-body p-0 table-responsive">
      <h6 class="fw-bold p-3 mb-0"><i class="bi bi-list-ul"></i> All Organizers ({{@model.organizers.length}})</h6>
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th>ID</th><th>Name</th><th>Matches Organized</th></tr>
        </thead>
        <tbody>
          {{#each @model.organizers as |o|}}
            <tr>
              <td class="text-muted small">{{o.organizer_id}}</td>
              <td class="fw-semibold">{{o.organizer_name}}</td>
              <td>
                {{#each @model.matches as |m|}}
                  {{#if (eq m.organizer_id o.organizer_id)}}
                    <span class="badge bg-secondary me-1">{{m.match_name}}</span>
                  {{/if}}
                {{/each}}
              </td>
            </tr>
          {{else}}
            <tr><td colspan="3"><div class="empty-state py-3"><p>No organizers yet</p></div></td></tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
{{/if}}

{{!-- ═══════════════════════════════════════ --}}
{{!-- ═══════ SCHEDULE MATCH TAB ═══════ --}}
{{!-- ═══════════════════════════════════════ --}}
{{#if (eq this.activeTab "match")}}
  <div class="card mb-4">
    <div class="card-body">
      <h6 class="fw-bold mb-3"><i class="bi bi-calendar-plus text-primary"></i> Schedule New Match</h6>
      <form {{on "submit" this.scheduleMatch}}>
        <div class="row g-3">
          <div class="col-md-4 col-6">
            <label class="form-label small fw-semibold">Match ID <span class="text-danger">*</span></label>
            <input type="number" name="match_id" class="form-control form-control-sm" required placeholder="Unique ID">
          </div>
          <div class="col-md-4 col-6">
            <label class="form-label small fw-semibold">Match Name <span class="text-danger">*</span></label>
            <input type="text" name="match_name" class="form-control form-control-sm" required placeholder="e.g. Alanganallur 2026">
          </div>
          <div class="col-md-4 col-6">
            <label class="form-label small fw-semibold">Date <span class="text-danger">*</span></label>
            <input type="date" name="match_date" class="form-control form-control-sm" required>
          </div>
          <div class="col-md-4 col-6">
            <label class="form-label small fw-semibold">Location <span class="text-danger">*</span></label>
            <select name="location_id" class="form-select form-select-sm" required>
              <option value="">Select...</option>
              {{#each @model.locations as |l|}}
                <option value={{l.location_id}}>{{l.area}}, {{l.district}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-4 col-6">
            <label class="form-label small fw-semibold">Organizer <span class="text-danger">*</span></label>
            <select name="organizer_id" class="form-select form-select-sm" required>
              <option value="">Select...</option>
              {{#each @model.organizers as |o|}}
                <option value={{o.organizer_id}}>{{o.organizer_name}}</option>
              {{/each}}
            </select>
          </div>
          <div class="col-md-2 col-6">
            <label class="form-label small fw-semibold">Player Limit</label>
            <input type="number" name="player_limit" class="form-control form-control-sm" placeholder="Max">
          </div>
          <div class="col-md-2 col-6">
            <label class="form-label small fw-semibold">Bull Limit</label>
            <input type="number" name="bull_limit" class="form-control form-control-sm" placeholder="Max">
          </div>
        </div>
        <button type="submit" class="btn btn-success btn-sm mt-3"><i class="bi bi-calendar-check"></i> Schedule</button>
      </form>
    </div>
  </div>

  <div class="card">
    <div class="card-body p-0 table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead class="table-light">
          <tr><th>ID</th><th>Name</th><th>Date</th><th>Capacity</th><th>Status</th></tr>
        </thead>
        <tbody>
          {{#each @model.matches as |m|}}
            <tr>
              <td class="text-muted small">{{m.match_id}}</td>
              <td class="fw-semibold">{{m.match_name}}</td>
              <td>{{m.match_date}}</td>
              <td>
                <small>P: {{m.registered_player_count}}/{{m.player_limit}} &bull; B: {{m.registered_bull_count}}/{{m.bull_limit}}</small>
              </td>
              <td>
                <span class="status-badge {{if (eq m.status 'Completed') 'completed' (if (eq m.status 'Live') 'live' 'scheduled')}}">
                  {{m.status}}
                </span>
              </td>
            </tr>
          {{else}}
            <tr>
              <td colspan="5">
                <div class="empty-state py-3"><i class="bi bi-calendar-x"></i><p>No matches scheduled</p></div>
              </td>
            </tr>
          {{/each}}
        </tbody>
      </table>
    </div>
  </div>
{{/if}}
